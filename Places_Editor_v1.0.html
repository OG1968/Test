<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="search.png" type="image/png" />
    <link rel="apple-touch-icon" href="search.png" />
    <title>××¢×¨×›×ª × ×™×”×•×œ ××§×•××•×ª</title>
    <style>
      :root {
        --primary-color: #4361ee;
        --primary-hover: #3a56d4;
        --secondary-color: #3f37c9;
        --success-color: #0074c7;
        --success-hover: #007fa5;
        --danger-color: #ff0000;
        --danger-hover: #ff5757;
        --warning-color: #ff8c00;
        --warning-hover: #ffab44;
        --info-color: #2e6500;
        --dark-color: #1a1a2e;
        --light-color: #f8f9fa;
        --gray-color: #6c757d;
        --border-color: #dee2e6;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 4px 6px rgba(0, 0, 0, 0.15);
        --radius: 6px;
        --transition: all 0.2s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        direction: rtl;
        padding: 20px;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.5;
        color: #333;
        background-color: #deebff;
      }

      h1,
      h2 {
        color: var(--dark-color);
      }

      h1 {
        font-size: 2.6rem;
        margin-bottom: 0.5rem;
        text-align: center;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 8px;
      }

      h2 {
        font-size: 1.4rem;
        margin-bottom: 0.1rem;
      }

      .form-group {
        margin-bottom: 0rem;
      }

      label {
        display: block;
        margin-bottom: 0rem;
        font-weight: 600;
        color: var(--dark-color);
      }

      .title-logo {
        width: 40px;
        height: 40px;
        vertical-align: middle;
        margin-left: 10px;
      }

      textarea,
      input,
      select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        transition: var(--transition);
        background-color: white;
      }

      textarea:focus,
      input:focus,
      select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
      }

      textarea {
        height: 80px;
        resize: vertical;
      }

      textarea#name {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 0.95rem;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        padding: 0.6rem 0.2rem;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        margin: 0.2rem 0;
        transition: var(--transition);
        box-shadow: var(--shadow);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
      }

      button:hover {
        background-color: var(--primary-hover);
        box-shadow: var(--shadow-hover);
      }

      button:active {
        transform: translateY(1px);
      }

      button:disabled {
        background-color: var(--gray-color);
        cursor: not-allowed;
        box-shadow: none;
      }

      #search-btn {
        background-color: var(--success-color);
      }

      #search-btn:hover {
        background-color: var(--success-hover);
      }

      #download-btn {
        background-color: var(--info-color);
        width: 50%;
        margin-top: 0.2rem;
      }

      #download-btn:hover {
        background-color: #19a400;
      }

      #upload-btn {
        background-color: var(--warning-color);
        width: 50%;
        margin-top: 0.2rem;
      }

      @media (max-width: 600px) {
        #download-btn,
        #upload-btn {
          width: 50%;
        }
      }

      #upload-btn:hover {
        background-color: var(--warning-hover);
      }

      button.delete {
        background-color: var(--danger-color);
      }

      button.delete:hover {
        background-color: var(--danger-hover);
      }

      #loading {
        display: none;
        margin-right: 0.4rem;
      }

      .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .place-item {
        background-color: white;
        padding: 1rem;
        margin-bottom: 0.8rem;
        border-radius: var(--radius);
        border-left: 3px solid var(--primary-color);
        box-shadow: var(--shadow);
        position: relative;
      }

      #json-output {
        background-color: white;
        padding: 0.8rem;
        border-radius: var(--radius);
        white-space: pre-wrap;
        font-family: "Courier New", Courier, monospace;
        font-size: 0.85rem;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
        max-height: 250px;
        overflow-y: auto;
      }

      .status-message {
        padding: 0.6rem 0.8rem;
        margin: 0.8rem 0;
        border-radius: var(--radius);
        display: none;
        font-weight: 1000;
        box-shadow: var(--shadow);
      }

      .error {
        background-color: #ffebee;
        color: var(--danger-color);
        border-left: 3px solid var(--danger-color);
      }

      .success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border-left: 3px solid #2e7d32;
      }

      .search-result {
        margin-bottom: 0.8rem;
        padding: 0.8rem;
        background-color: white;
        border-radius: var(--radius);
        position: relative;
        box-shadow: var(--shadow);
        border-left: 3px solid var(--info-color);
      }

      .search-result.error-result {
        border-left-color: var(--danger-color);
      }

      .search-result.not-found {
        border-left-color: var(--warning-color);
      }

      .button-group {
        display: flex;
        gap: 0.6rem;
        margin-bottom: 0.2rem;
        width: 100%;
      }

      .button-group button {
        flex: 1;
        min-width: 0;
      }

      .search-buttons {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.6rem;
      }

      .search-buttons button {
        flex: 1;
      }

      .editable-field {
        padding: 0.4rem;
        margin: 0.4rem 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        min-height: 20px;
        transition: var(--transition);
        font-size: 0.9rem;
        line-height: 3;
      }

      .editable-field:hover {
        background-color: #f0f4f8;
        border-color: var(--primary-color);
      }

      .edit-container {
        position: relative;
        margin: 0.4rem 0;
      }

      .edit-input {
        width: 100%;
        padding: 0.6rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        margin-bottom: 0.4rem;
      }

      .edit-textarea {
        width: 100%;
        padding: 0.6rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        min-height: 80px;
        resize: vertical;
        margin-bottom: 0.4rem;
      }

      .edit-select {
        width: 100%;
        padding: 0.6rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        background-color: white;
        margin-bottom: 0.4rem;
      }

      .save-cancel-buttons {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.4rem;
      }

      .save-cancel-buttons button {
        padding: 0.5rem 0.6rem;
        font-size: 0.85rem;
        flex: 1;
      }

      .save-btn {
        background-color: #2e7d32;
      }

      .save-btn:hover {
        background-color: #1b5e20;
      }

      .cancel-btn {
        background-color: var(--danger-color);
      }

      .cancel-btn:hover {
        background-color: var(--danger-hover);
      }

      .update-options {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.6rem;
      }

      .update-options button {
        flex: 1;
        padding: 0.6rem;
        font-size: 0.85rem;
      }

      .update-btn {
        background-color: var(--warning-color);
      }

      .update-btn:hover {
        background-color: var(--warning-hover);
      }

      @media (max-width: 600px) {
        body {
          padding: 15px;
        }

        h1 {
          font-size: 1.6rem;
        }

        h2 {
          font-size: 1.2rem;
        }

        .search-buttons,
        .update-options,
        .save-cancel-buttons {
          flex-direction: column;
        }

        .button-group {
          flex-direction: row;
          gap: 0.6rem;
        }

        button {
          width: 100%;
        }

        #json-output {
          font-size: 0.8rem;
          max-height: 200px;
        }
      }

      .download-upload-group {
        display: flex;
        gap: 0.6rem;
        margin-top: 0.8rem;
      }

      .status-message {
        position: relative;
        padding-right: 30px;
      }

      .close-status {
        position: absolute;
        right: 1px;
        top: 40%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: inherit;
      }

      .existing-places-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0rem 0;
      }

      .filter-controls {
        display: flex;
        gap: 0.6rem;
        margin-bottom: 1rem;
      }

      .filter-controls input,
      .filter-controls select {
        flex: 1;
      }

      .places-count {
        font-size: 0.9rem;
        color: var(--gray-color);
        margin-bottom: 0.5rem;
      }

      .place-actions {
        position: absolute;
        left: 10px;
        top: 10px;
        display: flex;
        gap: 0.4rem;
      }

      .place-actions button {
        padding: 1rem 0.6rem;
        font-size: 1rem;
        margin: 12px;
        margin-top: 150px;
        border-radius: 50%;
      }

      .icon {
        margin-left: 0.3rem;
      }

      .description {
        margin-top: 0.5rem;
      }

      .description-text {
        white-space: pre-line;
        margin-top: 5px;
        padding: 8px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        min-height: 40px;
        cursor: text;
      }

      .description-text:hover {
        border-color: var(--primary-color);
      }

      .scroll-to-top {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 20px;
        height: 20px;
        background: none;
        border: none;
        box-shadow: none;
        cursor: pointer;
        font-size: 30px;
        z-index: 1000;
        display: none;
        padding: 0;
        margin: 0;
        line-height: 1;
        color: var(--primary-color);
      }

      .scroll-to-top:hover {
        background: transparent !important;
        transform: none !important;
        box-shadow: none !important;
      }
      #clear-fields-btn {
        background-color: var(--primary-color);
      }

      #clear-fields-btn:hover {
        background-color: var(--primary-hover);
      }
    </style>
  </head>
  <body>
    <h1>
      <img src="search.png" alt="×œ×•×’×•" class="title-logo" />××¢×¨×›×ª × ×™×”×•×œ ××§×•××•×ª
    </h1>
    <div class="place-form">
      <div class="form-group">
        <label for="name">×”×–×Ÿ ×©××•×ª ××§×•××•×ª (×©×•×¨×•×ª × ×¤×¨×“×•×ª)</label>
        <textarea
          id="name"
          required
          placeholder="×”×–×Ÿ ×©× ××§×•× ××—×“ ××• ×™×•×ª×¨ ×‘××•×¤×Ÿ ×”×‘×:
××’×“×œ ××™×™×¤×œ
×©×¢×¨ ×”× ×™×¦×—×•×Ÿ"
        ></textarea>
        <div class="form-group">
          <label for="city">×¢×™×¨</label>
          <input type="text" id="city" placeholder="×œ×“×•×’××”: ×¤×¨×™×– (En/Heb)" />
        </div>
        <div class="form-group">
          <label for="country">××“×™× ×”</label>
          <input type="text" id="country" placeholder="×œ×“×•×’××”: ×¦×¨×¤×ª (En/Heb)" />
        </div>
        <div class="form-group">
          <label for="category">×§×˜×’×•×¨×™×”</label>
          <select id="category">
            <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
            <option value="lodging">×©××•×¨×™×</option>
            <option value="attraction">××ª×¨ ×ª×™×¨×•×ª×™</option>
            <option value="restaurant">××¡×¢×“×”</option>
            <option value="cafe">×‘×™×ª ×§×¤×”</option>
            <option value="pub">×¤××‘</option>
            <option value="shopping">×©×•×¤×™× ×’</option>
            <option value="other">××—×¨</option>
          </select>
        </div>
        <div class="button-group">
          <button id="search-btn">
            <span id="loading"> <span class="spinner"></span> ××—×¤×©... </span>
            ×—×¤×© ××§×•××•×ª
          </button>
          <button id="clear-fields-btn">× ×§×” ×©×“×•×ª</button>
          <button id="clear-btn" class="delete">× ×§×” ×–×™×›×¨×•×Ÿ</button>
        </div>
        <div id="status-message" class="status-message"></div>
      </div>
      <div id="search-results" style="display: none">
        <h2>×ª×•×¦××•×ª ×—×™×¤×•×©</h2>
        <div id="results-container"></div>
      </div>

      <div id="existing-places-section">
        <div class="existing-places-header">
          <h2>××§×•××•×ª ×§×™×™××™×</h2>
          <div class="places-count" id="places-count"></div>
        </div>
        <div class="filter-controls">
          <input type="text" id="places-search" placeholder="×—×¤×© ××§×•××•×ª..." />
          <select id="places-category-filter">
            <option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
            <option value="lodging">×©××•×¨×™×</option>
            <option value="attraction">××ª×¨ ×ª×™×¨×•×ª×™</option>
            <option value="restaurant">××¡×¢×“×”</option>
            <option value="cafe">×‘×™×ª ×§×¤×”</option>
            <option value="pub">×¤××‘</option>
            <option value="shopping">×©×•×¤×™× ×’</option>
            <option value="other">××—×¨</option>
          </select>
        </div>
        <div id="existing-places-container"></div>
      </div>

      <div>
        <h2>×ª×¦×•×’×” ××§×“×™××”</h2>
        <pre id="json-output" dir="ltr">[]</pre>
      </div>
      <div class="download-upload-group">
        <button id="download-btn">×”×•×¨×“ ×§×•×‘×¥ JSON</button>
        <button id="upload-btn">×”×¢×œ×” ×§×•×‘×¥ JSON</button>
      </div>
      <input type="file" id="file-input" accept=".json" style="display: none" />
    </div>
    <button
      class="scroll-to-top"
      onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
      aria-label="×’×œ×™×œ×” ×œ××¢×œ×”"
    >
      â¬†ï¸
    </button>

    <script>
      // ×›×¤×ª×•×¨ ×’×œ×™×œ×” ××¢×œ×”
      window.addEventListener("scroll", function () {
        const scrollButton = document.querySelector(".scroll-to-top");
        scrollButton.style.display =
          window.pageYOffset > 300 ? "block" : "none";
      });

      // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
      let places = [];
      let nextId = Date.now();
      let lastSearchResults = [];
      let currentEditField = null;
      let outsideClickHandler = null;
      let searchStatus = {
        found: 0,
        notFound: 0,
        duplicates: 0,
        errors: 0,
        updated: 0,
      };

      // ××™×œ×•×Ÿ ×ª×¨×’×•× ××•×¨×—×‘
      const hebrewToEnglish = {
        "××’×“×œ ××™×™×¤×œ": "Eiffel Tower",
        ×¤×¨×™×–: "Paris",
        ×¦×¨×¤×ª: "France",
        ×™×¨×•×©×œ×™×: "Jerusalem",
        "×ª×œ ××‘×™×‘": "Tel Aviv",
        ×™×©×¨××œ: "Israel",
        "×©×¢×¨ ×”× ×™×¦×—×•×Ÿ": "Arc de Triomphe",
        "×§×˜×“×¨×œ×ª × ×•×˜×¨×“××": "Notre Dame Cathedral",
        "××•×–×™××•×Ÿ ×”×œ×•×‘×¨": "Louvre Museum",
        "×˜×™×¨×ª ×•×™× ×“×–×•×¨": "Windsor Castle",
        "×›×™×›×¨ ×˜×¨×¤×œ×’×¨": "Trafalgar Square",
      };

      // ××™×¨×•×¢×™×
      document
        .getElementById("search-btn")
        .addEventListener("click", searchPlace);
      document
        .getElementById("download-btn")
        .addEventListener("click", downloadJSON);
      document
        .getElementById("clear-btn")
        .addEventListener("click", clearLocalStorage);
      document
        .getElementById("upload-btn")
        .addEventListener("click", function () {
          document.getElementById("file-input").click();
        });
      document
        .getElementById("places-search")
        .addEventListener("input", filterPlaces);
      document
        .getElementById("places-category-filter")
        .addEventListener("change", filterPlaces);
      window.addEventListener("DOMContentLoaded", loadFromLocalStorage);
      document
        .getElementById("file-input")
        .addEventListener("change", handleFileUpload);

      // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
      function showStatus(message, isError = false) {
        const statusDiv = document.getElementById("status-message");
        // ×‘×“×™×§×” ×× ×”×”×•×“×¢×” ×›×‘×¨ ××ª×—×™×œ×” ×‘×××•×’'×™
        const startsWithEmoji = /^[^\w]/.test(message.trim());

        statusDiv.innerHTML = `
    ${!startsWithEmoji ? (isError ? "âŒ" : "âœ…") : ""} ${message}
    <button class="close-status" onclick="this.parentElement.style.display='none'">&times;</button>
  `;
        statusDiv.className = isError
          ? "status-message error"
          : "status-message success";
        statusDiv.style.display = "block";

        if (!isError) {
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 5000);
        }
      }

      function cleanAddress(place) {
        if (place.address) {
          const addr = place.address;
          const street = [addr.road, addr.house_number]
            .filter(Boolean)
            .join(" ");
          const city = addr.city || addr.town || addr.village || "";
          const postcode = addr.postcode || "";
          const country = addr.country || "";
          return [street, postcode, city, country].filter(Boolean).join(", ");
        }
        return place.display_name || "×›×ª×•×‘×ª ×œ× ×™×“×•×¢×”";
      }

      function findExistingPlace(placeToFind) {
        return places.find((existingPlace) => {
          const nameMatch =
            existingPlace.name.toLowerCase() === placeToFind.name.toLowerCase();
          const addressMatch =
            existingPlace.address.toLowerCase() ===
            placeToFind.address.toLowerCase();
          return nameMatch && addressMatch;
        });
      }

      function getCategoryName(categoryValue) {
        const categoryMap = {
          lodging: "×©××•×¨×™×",
          attraction: "××ª×¨ ×ª×™×¨×•×ª×™",
          restaurant: "××¡×¢×“×”",
          cafe: "×‘×™×ª ×§×¤×”",
          pub: "×¤××‘",
          shopping: "×©×•×¤×™× ×’",
          other: "××—×¨",
        };
        return categoryMap[categoryValue] || categoryValue;
      }

      // ×¤×•× ×§×¦×™×•×ª ×¢×™×§×¨×™×•×ª
      async function searchPlace() {
        const nameInput = document.getElementById("name").value;
        const city = document.getElementById("city").value.trim();
        const country = document.getElementById("country").value.trim();
        const category = document.getElementById("category").value;

        const placeNames = nameInput
          .split("\n")
          .map((line) => line.trim())
          .filter(
            (line) => line && !line.startsWith("//") && !line.startsWith("#")
          );

        if (placeNames.length === 0) {
          showStatus("âŒ ×× × ×”×–×Ÿ ×œ×¤×—×•×ª ×©× ××§×•× ××—×“", true);
          return;
        }

        searchStatus = {
          found: 0,
          notFound: 0,
          duplicates: 0,
          errors: 0,
          updated: 0,
        };

        document.getElementById("loading").style.display = "inline";
        document.getElementById("search-btn").disabled = true;
        document.getElementById("results-container").innerHTML = "";
        showStatus(`ğŸ” ××ª×—×™×œ ×œ×—×¤×© ${placeNames.length} ××§×•××•×ª...`);

        try {
          lastSearchResults = [];
          for (const name of placeNames) {
            try {
              let query = name;
              let translatedName = hebrewToEnglish[name];

              let found = await trySearch(name, city, country, category);

              if (!found && translatedName) {
                showStatus(
                  `ğŸ”  ×× ×¡×” ×—×™×¤×•×© ×¢× ×ª×¨×’×•×: ${name} -> ${translatedName}`
                );
                found = await trySearch(
                  translatedName,
                  city,
                  country,
                  category
                );
                if (found) {
                  found.originalName = name;
                }
              }

              if (!found) {
                lastSearchResults.push({
                  originalName: name,
                  category: category,
                  notFound: true,
                  details: "×¤×¨×˜×™× × ×•×¡×¤×™× ×œ× ×–××™× ×™×",
                });
                searchStatus.notFound++;
                showStatus(
                  `ğŸ” ×œ× × ××¦×: ${name} (× ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${searchStatus.notFound}, ×©×’×™××•×ª: ${searchStatus.errors})`
                );
              }

              await new Promise((resolve) => setTimeout(resolve, 1100));
            } catch (error) {
              console.error(`×©×’×™××” ×‘×—×™×¤×•×© ${name}:`, error);
              lastSearchResults.push({
                originalName: name,
                category: category,
                error: true,
                details: `×©×’×™××”: ${error.message || "×¤×¨×˜×™× × ×•×¡×¤×™× ×œ× ×–××™× ×™×"}`,
              });
              searchStatus.errors++;
              showStatus(
                `âŒ ×©×’×™××” ×‘×—×™×¤×•×© ${name}: ${
                  error.message || "×©×’×™××” ×œ× ×™×“×•×¢×”"
                } (× ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${
                  searchStatus.notFound
                }, ×©×’×™××•×ª: ${searchStatus.errors})`,
                true
              );
            }
          }

          displaySearchResults();

          if (searchStatus.errors > 0) {
            showStatus(
              `âš ï¸ ×¡×™×•× ×—×™×¤×•×© ×¢× ×©×’×™××•×ª - × ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${searchStatus.notFound}, ×©×’×™××•×ª: ${searchStatus.errors}`,
              true
            );
          } else if (searchStatus.found === 0) {
            showStatus(
              `â„¹ï¸ ×œ× × ××¦××• ×ª×•×¦××•×ª - × ×¡×” ×©××•×ª ××—×¨×™× ××• ×‘×“×•×§ ××ª ×”××™×•×ª`,
              true
            );
          } else {
            showStatus(
              `âœ… ×¡×™×•× ×—×™×¤×•×© - × ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${searchStatus.notFound}`,
              false
            );
          }
        } catch (error) {
          console.error("×©×’×™××” ×›×œ×œ×™×ª ×‘×—×™×¤×•×©:", error);
          showStatus(
            `âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×—×™×¤×•×©: ${
              error.message || "×¤×¨×˜×™× ×œ× ×–××™× ×™×"
            } (× ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${
              searchStatus.notFound
            }, ×©×’×™××•×ª: ${searchStatus.errors})`,
            true
          );
        } finally {
          document.getElementById("loading").style.display = "none";
          document.getElementById("search-btn").disabled = false;
        }
      }

      async function trySearch(name, city, country, category) {
        const queryParts = [name];
        if (city) queryParts.push(city);
        if (country) queryParts.push(country);
        const query = queryParts.join(", ");

        const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(
          query
        )}&format=json&addressdetails=1&limit=1&accept-language=en&extratags=1`;

        try {
          const nominatimResponse = await fetch(nominatimUrl, {
            headers: {
              "User-Agent": "PlaceManagementApp/1.0",
              "Accept-Language": "en",
            },
          });

          if (!nominatimResponse.ok) {
            throw new Error(`×©×’×™××ª HTTP: ${nominatimResponse.status}`);
          }

          const nominatimResult = await nominatimResponse.json();
          if (nominatimResult && nominatimResult.length > 0) {
            const foundPlace = nominatimResult[0];
            let description = await getPlaceDescription(foundPlace);

            if (description.length > 500) {
              description = description.substring(0, 497) + "...";
            }

            lastSearchResults.push({
              ...foundPlace,
              originalName: name,
              category: category,
              details: description,
            });

            searchStatus.found++;
            showStatus(
              `ğŸ” ××¦××ª×™: ${name} (× ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${searchStatus.notFound}, ×©×’×™××•×ª: ${searchStatus.errors})`
            );
            return true;
          }
          return false;
        } catch (error) {
          console.error("×©×’×™××” ×‘×—×™×¤×•×©:", error);
          throw error;
        }
      }

      async function getPlaceDescription(place) {
        // ×§×•×“× × ×‘×“×•×§ ×× ×™×© ×§×™×©×•×¨ ×™×©×™×¨ ×œ×•×™×§×™×¤×“×™×”
        if (place.extratags?.wikipedia) {
          try {
            const wikiTitle = place.extratags.wikipedia.split(":").pop();
            const wikiExtract = await getWikipediaExtract(wikiTitle);
            if (wikiExtract && wikiExtract !== "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ") {
              return wikiExtract;
            }
          } catch (e) {
            console.error("×©×’×™××” ×‘×§×‘×œ×ª ×ª×™××•×¨ ×-Wikipedia:", e);
          }
        }

        // ×× ××™×Ÿ ×•×™×§×™×¤×“×™×”, × ×‘×“×•×§ ×‘-Wikidata
        if (place.extratags?.wikidata) {
          try {
            const wikidataId = place.extratags.wikidata;
            const wikiDescription = await getWikidataDescription(wikidataId);
            if (wikiDescription && wikiDescription !== "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ") {
              return wikiDescription;
            }
          } catch (e) {
            console.error("×©×’×™××” ×‘×§×‘×œ×ª ×ª×™××•×¨ ×-Wikidata:", e);
          }
        }

        // ×× ×›×œ ×”×©××¨ × ×›×©×œ, × ×©×ª××© ×‘××™×“×¢ ×”×‘×¡×™×¡×™
        if (place.type) {
          const typeDescriptions = {
            attraction: "××ª×¨ ×ª×™×™×¨×•×ª ×¤×•×¤×•×œ×¨×™",
            monument: "××•× ×•×× ×˜ ××• ×× ×“×¨×˜×” ×”×™×¡×˜×•×¨×™×ª",
            museum: "××•×–×™××•×Ÿ ××• ×’×œ×¨×™×”",
            tower: "××’×“×œ ××• ××‘× ×” ×’×‘×•×”",
            bridge: "×’×©×¨ ××• ××¢×‘×¨ ××¢×œ ××™×",
            castle: "×˜×™×¨×” ××• ××‘×¦×¨ ×”×™×¡×˜×•×¨×™",
            park: "×¤××¨×§ ××• ×’×Ÿ ×¦×™×‘×•×¨×™",
          };
          return typeDescriptions[place.type] || `××ª×¨ ××¡×•×’ ${place.type}`;
        }

        return "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ";
      }

      async function getWikidataDescription(wikidataId) {
        const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${wikidataId}&props=descriptions&languages=he&format=json&origin=*`;

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error("×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™× ×-Wikidata");
        }

        const data = await response.json();
        const entity = data.entities[wikidataId];

        if (entity.descriptions?.he) {
          return entity.descriptions.he.value;
        }

        return "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ";
      }

      async function getWikipediaExtract(title) {
        // × × ×¡×” ×¨××©×•×Ÿ ×œ×§×‘×œ ××ª ×”×ª×™××•×¨ ×‘×¢×‘×¨×™×ª
        const hebrewUrl = `https://he.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro=true&explaintext=true&titles=${encodeURIComponent(
          title
        )}&origin=*`;

        const hebrewResponse = await fetch(hebrewUrl);
        if (hebrewResponse.ok) {
          const data = await hebrewResponse.json();
          const pages = data.query.pages;
          const pageId = Object.keys(pages)[0];

          if (pageId !== "-1" && pages[pageId].extract) {
            const hebrewExtract = pages[pageId].extract;
            if (hebrewExtract.length > 100) {
              return hebrewExtract;
            }
          }
        }

        // ×× ×œ× ××¦×× ×• ×ª×™××•×¨ ××¡×¤×§ ×‘×¢×‘×¨×™×ª, × × ×¡×” ×‘×× ×’×œ×™×ª
        const englishUrl = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro=true&explaintext=true&titles=${encodeURIComponent(
          title
        )}&origin=*`;

        const englishResponse = await fetch(englishUrl);
        if (!englishResponse.ok) {
          throw new Error("×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™× ×-Wikipedia");
        }

        const englishData = await englishResponse.json();
        const englishPages = englishData.query.pages;
        const englishPageId = Object.keys(englishPages)[0];

        if (englishPageId === "-1" || !englishPages[englishPageId].extract) {
          return "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ";
        }

        // ×ª×¨×’×•× ×‘×¡×™×¡×™ ×©×œ ××•× ×—×™× × ×¤×•×¦×™× ××× ×’×œ×™×ª ×œ×¢×‘×¨×™×ª
        const translatedExtract = englishPages[englishPageId].extract
          .replace(/Eiffel Tower/g, "××’×“×œ ××™×™×¤×œ")
          .replace(/Paris/g, "×¤×¨×™×–")
          .replace(/France/g, "×¦×¨×¤×ª")
          .replace(/built in/g, "× ×‘× ×” ×‘")
          .replace(/height/g, "×’×•×‘×”")
          .replace(/meters/g, "××˜×¨×™×");

        return translatedExtract;
      }

      function displaySearchResults() {
        const container = document.getElementById("results-container");
        container.innerHTML = "";

        if (lastSearchResults.length === 0) {
          container.innerHTML = "<p>×œ× × ××¦××• ×ª×•×¦××•×ª</p>";
          return;
        }

        lastSearchResults.forEach((place, index) => {
          const div = document.createElement("div");
          div.className = "search-result";
          if (place.error) div.className += " error-result";
          if (place.notFound) div.className += " not-found";
          div.dataset.index = index;

          if (place.error) {
            div.innerHTML = `
                      <div class="editable-field" data-field="name">${
                        place.originalName
                      }</div>
                      <p style="color: var(--danger-color);">×©×’×™××” ×‘×—×™×¤×•×©: ${
                        place.details
                      }</p>
                      <div class="search-buttons">
                          <button onclick="addManualPlace('${place.originalName.replace(
                            /'/g,
                            "\\'"
                          )}')">×”×•×¡×£ ×™×“× ×™×ª</button>
                          <button onclick="removeSearchResult(${index})" class="delete">××—×§</button>
                      </div>
                  `;
          } else if (place.notFound) {
            div.innerHTML = `
                      <div class="editable-field" data-field="name">${
                        place.originalName
                      }</div>
                      <p>×œ× × ××¦×</p>
                      <p>
                          <strong>×¤×¨×˜×™× × ×•×¡×¤×™×:</strong>
                          <span class="editable-field" data-field="details" style="white-space: pre-line;">${
                            place.details
                          }</span>
                      </p>
                      <div class="search-buttons">
                          <button onclick="addManualPlace('${place.originalName.replace(
                            /'/g,
                            "\\'"
                          )}')">×”×•×¡×£ ×™×“× ×™×ª</button>
                          <button onclick="removeSearchResult(${index})" class="delete">××—×§</button>
                      </div>
                  `;
          } else {
            const displayName = place.display_name.split(",")[0];
            div.innerHTML = `
                      <div class="editable-field" data-field="name">${displayName}</div>
                      <p>
                          <strong>×›×ª×•×‘×ª:</strong>
                          <span class="editable-field" data-field="address">${cleanAddress(
                            place
                          )}</span>
                      </p>
                      <p>
                          <strong>×§×•××•×¨×“×™× ×˜×•×ª:</strong>
                          <span class="editable-field" data-field="lat">${
                            place.lat
                          }</span>, 
                          <span class="editable-field" data-field="lng">${
                            place.lon
                          }</span>
                      </p>
                      <p>
                          <strong>×§×˜×’×•×¨×™×”:</strong>
                          <span class="editable-field" data-field="category">${
                            document.getElementById("category").options[
                              document.getElementById("category").selectedIndex
                            ].text
                          }</span>
                      </p>
                      <div class="description">
                          <strong>×ª×™××•×¨ ×”××§×•×:</strong>
                          <div class="description-text editable-field" data-field="details">${
                            place.details || "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ"
                          }</div>
                      </div>
                      <div class="update-options">
                          <button onclick="addSelectedPlace(${index})">×”×•×¡×£ ×›×—×“×©</button>
                          <button onclick="updateExistingPlace(${index})" class="update-btn">×¢×“×›×Ÿ ×§×™×™×</button>
                          <button onclick="removeSearchResult(${index})" class="delete">××—×§</button>
                      </div>
                  `;
          }
          container.appendChild(div);
        });

        document.querySelectorAll(".editable-field").forEach((field) => {
          field.addEventListener("click", function (e) {
            e.stopPropagation();
            if (currentEditField && currentEditField !== this) {
              const inputElement = currentEditField.querySelector(
                ".edit-input, .edit-textarea, .edit-select"
              );
              if (inputElement) {
                const fieldName = currentEditField.dataset.field;
                saveEdit(currentEditField, inputElement, fieldName);
              }
            }
            startEditField(this);
          });
        });

        document.getElementById("search-results").style.display = "block";
      }

      function startEditField(fieldElement) {
        if (fieldElement === currentEditField) {
          return;
        }

        if (currentEditField) {
          const inputElement = currentEditField.querySelector(
            ".edit-input, .edit-textarea, .edit-select"
          );
          if (inputElement) {
            const fieldName = currentEditField.dataset.field;
            saveEdit(currentEditField, inputElement, fieldName);
          }
        }

        currentEditField = fieldElement;
        const currentValue = fieldElement.textContent;
        const fieldName = fieldElement.dataset.field;
        const isCategory = fieldName === "category";
        const isDetails = fieldName === "details";
        const isCoordinates = fieldName === "lat" || fieldName === "lng";

        fieldElement.dataset.originalValue = currentValue;
        let inputElement;

        if (isCategory) {
          inputElement = document.createElement("select");
          inputElement.className = "edit-select";
          const categories = [
            { value: "lodging", text: "×©××•×¨×™×" },
            { value: "attraction", text: "××ª×¨ ×ª×™×¨×•×ª×™" },
            { value: "restaurant", text: "××¡×¢×“×”" },
            { value: "cafe", text: "×‘×™×ª ×§×¤×”" },
            { value: "pub", text: "×¤××‘" },
            { value: "shopping", text: "×©×•×¤×™× ×’" },
            { value: "other", text: "××—×¨" },
          ];

          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.value;
            option.textContent = cat.text;
            if (currentValue === cat.text) option.selected = true;
            inputElement.appendChild(option);
          });
        } else if (isDetails) {
          inputElement = document.createElement("textarea");
          inputElement.className = "edit-textarea";
          inputElement.value = currentValue;
        } else {
          inputElement = document.createElement("input");
          inputElement.type = isCoordinates ? "number" : "text";
          inputElement.className = "edit-input";
          inputElement.value = currentValue;
        }

        const saveButton = document.createElement("button");
        saveButton.textContent = "×©××•×¨";
        saveButton.className = "save-btn";

        const cancelButton = document.createElement("button");
        cancelButton.textContent = "×‘×™×˜×•×œ";
        cancelButton.className = "cancel-btn";

        const buttonsContainer = document.createElement("div");
        buttonsContainer.className = "save-cancel-buttons";
        buttonsContainer.appendChild(saveButton);
        buttonsContainer.appendChild(cancelButton);

        const editContainer = document.createElement("div");
        editContainer.className = "edit-container";
        editContainer.appendChild(inputElement);
        editContainer.appendChild(buttonsContainer);

        fieldElement.innerHTML = "";
        fieldElement.appendChild(editContainer);
        inputElement.focus();

        saveButton.addEventListener("click", function (e) {
          e.stopPropagation();
          saveEdit(fieldElement, inputElement, fieldName);
        });

        cancelButton.addEventListener("click", function (e) {
          e.stopPropagation();
          cancelEdit(fieldElement);
        });

        inputElement.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !isDetails) {
            e.preventDefault();
            saveEdit(fieldElement, inputElement, fieldName);
          } else if (e.key === "Escape") {
            e.preventDefault();
            cancelEdit(fieldElement);
          }
        });

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
        }

        outsideClickHandler = function (e) {
          if (!fieldElement.contains(e.target)) {
            const inputElement = fieldElement.querySelector(
              ".edit-input, .edit-textarea, .edit-select"
            );
            if (inputElement) {
              saveEdit(fieldElement, inputElement, fieldElement.dataset.field);
            }
          }
        };

        setTimeout(() => {
          document.addEventListener("click", outsideClickHandler);
        }, 10);
      }

      function saveEdit(fieldElement, inputElement, fieldName) {
        let newValue;
        if (inputElement.tagName === "SELECT") {
          newValue = inputElement.options[inputElement.selectedIndex].text;
        } else {
          newValue = inputElement.value
            .replace(/\\r\\n/g, "\n")
            .replace(/\\n/g, "\n")
            .replace(/\r\n/g, "\n")
            .replace(/\n/g, "\n");
        }

        fieldElement.textContent = newValue;
        fieldElement.addEventListener("click", function (e) {
          e.stopPropagation();
          startEditField(this);
        });

        const resultIndex = parseInt(
          fieldElement.closest(".search-result").dataset.index
        );
        const place = lastSearchResults[resultIndex];

        if (fieldName === "name") {
          if (place.originalName) {
            place.originalName = newValue;
          }
          if (place.display_name) {
            const parts = place.display_name.split(",");
            parts[0] = newValue;
            place.display_name = parts.join(",");
          } else {
            place.display_name = newValue + ", " + (place.address || "");
          }
        } else if (fieldName === "address") {
          place.display_name = newValue;
        } else if (fieldName === "lat") {
          place.lat = parseFloat(newValue) || 0;
        } else if (fieldName === "lng") {
          place.lon = parseFloat(newValue) || 0;
        } else if (fieldName === "category") {
          place.category = inputElement.value;
        } else if (fieldName === "details") {
          place.details = newValue;
        }

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
          outsideClickHandler = null;
        }

        currentEditField = null;
      }

      function cancelEdit(fieldElement) {
        fieldElement.textContent = fieldElement.dataset.originalValue;
        fieldElement.addEventListener("click", function (e) {
          e.stopPropagation();
          startEditField(this);
        });

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
          outsideClickHandler = null;
        }

        currentEditField = null;
      }

      function removeSearchResult(index) {
        if (confirm("âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×ª×•×¦××ª ×”×—×™×¤×•×© ×”×–×•?")) {
          lastSearchResults.splice(index, 1);
          displaySearchResults();
          showStatus("ğŸ—‘ï¸ ×”×¨×©×•××” × ××—×§×” ×‘×”×¦×œ×—×”", false);
        }
      }

      function addSelectedPlace(index) {
        const place = lastSearchResults[index];
        const newPlace = {
          id: nextId++,
          category: place.category,
          name: place.display_name.split(",")[0] || place.originalName,
          address: cleanAddress(place),
          lat: parseFloat(place.lat),
          lng: parseFloat(place.lon),
          details: place.details || "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ",
        };

        const existingPlace = findExistingPlace(newPlace);
        if (existingPlace) {
          searchStatus.duplicates++;
          showStatus(
            `âš ï¸ "${newPlace.name}" ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××” (× ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${searchStatus.notFound}, ×©×’×™××•×ª: ${searchStatus.errors}, ×›×¤×™×œ×•×™×•×ª: ${searchStatus.duplicates})`,
            true
          );
          return;
        }

        places.push(newPlace);
        saveToLocalStorage();
        updateJSONPreview();
        showStatus(
          `âœ… "${newPlace.name}" × ×•×¡×£ ×œ×¨×©×™××” ×‘×”×¦×œ×—×” (× ××¦××•: ${searchStatus.found}, ×œ× × ××¦××•: ${searchStatus.notFound}, ×©×’×™××•×ª: ${searchStatus.errors}, ×›×¤×™×œ×•×™×•×ª: ${searchStatus.duplicates})`,
          false
        );
      }

      function updateExistingPlace(index) {
        const place = lastSearchResults[index];
        const updatedPlace = {
          id: nextId++,
          category: place.category,
          name: place.display_name?.split(",")[0] || place.originalName,
          address: cleanAddress(place),
          lat: parseFloat(place.lat),
          lng: parseFloat(place.lon),
          details: place.details || "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ",
        };

        const existingPlaceIndex = places.findIndex(
          (p) =>
            p.name.toLowerCase() === updatedPlace.name.toLowerCase() &&
            p.address.toLowerCase() === updatedPlace.address.toLowerCase()
        );

        if (existingPlaceIndex !== -1) {
          if (
            confirm(
              `âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¢×“×›×Ÿ ××ª ×”××§×•× "${updatedPlace.name}"?\n\n×”×§×˜×’×•×¨×™×” ×ª×©×ª× ×” ×-"${places[existingPlaceIndex].category}" ×œ-"${updatedPlace.category}"`
            )
          ) {
            updatedPlace.id = places[existingPlaceIndex].id;
            Object.assign(places[existingPlaceIndex], updatedPlace);
            searchStatus.updated++;
            showStatus(
              `âœ… "${updatedPlace.name}" ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” (×§×˜×’×•×¨×™×”: ${updatedPlace.category})`,
              false
            );
          }
        } else {
          places.push(updatedPlace);
          showStatus(`âœ… "${updatedPlace.name}" × ×•×¡×£ ×œ×¨×©×™××” ×‘×”×¦×œ×—×”`, false);
        }

        saveToLocalStorage();
        updateJSONPreview();
      }

      function addManualPlace(name) {
        const category = document.getElementById("category").value;
        const details =
          prompt("×”×–×Ÿ ×¤×¨×˜×™× ×¢×œ ×”××§×•×:", "×¤×¨×˜×™× ×¢×œ ×”××§×•×") || "××™×Ÿ ×¤×¨×˜×™× × ×•×¡×¤×™×";
        const newPlace = {
          id: nextId++,
          category: category,
          name: name,
          address: prompt("×”×–×Ÿ ×›×ª×•×‘×ª:", "×›×ª×•×‘×ª ×œ× ×™×“×•×¢×”") || "×›×ª×•×‘×ª ×œ× ×™×“×•×¢×”",
          lat: parseFloat(prompt("×”×–×Ÿ ×§×• ×¨×•×—×‘:", "0")) || 0,
          lng: parseFloat(prompt("×”×–×Ÿ ×§×• ××•×¨×š:", "0")) || 0,
          details: details.replace(/\r\n/g, "\n").replace(/\n/g, "\n"),
        };

        const existingPlace = findExistingPlace(newPlace);
        if (existingPlace) {
          if (
            confirm(
              `âš ï¸ "${name}" ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××”. ×”×× ×‘×¨×¦×•× ×š ×œ×¢×“×›×Ÿ ××ª ×”×¨×©×•××” ×”×§×™×™××ª?\n\n×”×§×˜×’×•×¨×™×” ×ª×ª×¢×“×›×Ÿ ×-"${existingPlace.category}" ×œ-"${newPlace.category}"`
            )
          ) {
            Object.assign(existingPlace, newPlace);
            searchStatus.updated++;
            showStatus(
              `âœ… "${name}" ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” (×§×˜×’×•×¨×™×”: ${newPlace.category})`,
              false
            );
          } else {
            searchStatus.duplicates++;
            showStatus(`âš ï¸ "${name}" ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××” ×•×œ× ×¢×•×“×›×Ÿ`, true);
            return;
          }
        } else {
          places.push(newPlace);
          showStatus(`âœ… "${name}" × ×•×¡×£ ×™×“× ×™×ª ×œ×¨×©×™××”`, false);
        }

        saveToLocalStorage();
        updateJSONPreview();
      }

      function displayExistingPlaces() {
        filterPlaces();
      }

      function filterPlaces() {
        const searchTerm = document
          .getElementById("places-search")
          .value.toLowerCase();
        const categoryFilter = document.getElementById(
          "places-category-filter"
        ).value;

        const filteredPlaces = places.filter((place) => {
          const matchesSearch =
            place.name.toLowerCase().includes(searchTerm) ||
            place.address.toLowerCase().includes(searchTerm) ||
            place.details.toLowerCase().includes(searchTerm);

          const matchesCategory =
            !categoryFilter || place.category === categoryFilter;

          return matchesSearch && matchesCategory;
        });

        renderExistingPlaces(filteredPlaces);
      }

      function renderExistingPlaces(placesToRender) {
        const container = document.getElementById("existing-places-container");
        container.innerHTML = "";

        if (placesToRender.length === 0) {
          container.innerHTML = "<p>×œ× × ××¦××• ××§×•××•×ª</p>";
          document.getElementById("places-count").textContent = "";
          return;
        }

        document.getElementById(
          "places-count"
        ).textContent = `××¦×™×’ ${placesToRender.length} ××ª×•×š ${places.length} ××§×•××•×ª`;

        placesToRender.forEach((place) => {
          const div = document.createElement("div");
          div.className = "place-item";
          div.dataset.id = place.id;

          div.innerHTML = `
            <div class="place-actions">
              <button onclick="deleteExistingPlace(${
                place.id
              })" class="delete">××—×§</button>
            </div>
            <h3 class="editable-field" data-field="name" data-id="${
              place.id
            }">${place.name}</h3>
            <p>
              <strong>×›×ª×•×‘×ª:</strong>
              <span class="editable-field" data-field="address" data-id="${
                place.id
              }">${place.address}</span>
            </p>
            <p>
              <strong>×§×•××•×¨×“×™× ×˜×•×ª:</strong>
              <span class="editable-field" data-field="lat" data-id="${
                place.id
              }">${place.lat}</span>,
              <span class="editable-field" data-field="lng" data-id="${
                place.id
              }">${place.lng}</span>
            </p>
            <p>
              <strong>×§×˜×’×•×¨×™×”:</strong>
              <span class="editable-field" data-field="category" data-id="${
                place.id
              }">${getCategoryName(place.category)}</span>
            </p>
            <div class="description">
              <strong>×ª×™××•×¨:</strong>
              <div class="description-text editable-field" data-field="details" data-id="${
                place.id
              }">${place.details || "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ"}</div>
            </div>
          `;

          container.appendChild(div);
        });

        // ×”×•×¡×¤×ª ××™×¨×•×¢×™ ×œ×—×™×¦×” ×œ×©×“×•×ª ×”× ×™×ª× ×™× ×œ×¢×¨×™×›×”
        document.querySelectorAll(".editable-field").forEach((field) => {
          field.addEventListener("click", function (e) {
            e.stopPropagation();
            if (currentEditField && currentEditField !== this) {
              const inputElement = currentEditField.querySelector(
                ".edit-input, .edit-textarea, .edit-select"
              );
              if (inputElement) {
                const fieldName = currentEditField.dataset.field;
                const placeId = currentEditField.dataset.id;
                saveExistingPlaceEdit(
                  currentEditField,
                  inputElement,
                  fieldName,
                  placeId
                );
              }
            }
            startEditExistingField(this);
          });
        });
      }

      function startEditExistingField(fieldElement) {
        if (fieldElement === currentEditField) {
          return;
        }

        if (currentEditField) {
          const inputElement = currentEditField.querySelector(
            ".edit-input, .edit-textarea, .edit-select"
          );
          if (inputElement) {
            const fieldName = currentEditField.dataset.field;
            const placeId = currentEditField.dataset.id;
            saveExistingPlaceEdit(
              currentEditField,
              inputElement,
              fieldName,
              placeId
            );
          }
        }

        currentEditField = fieldElement;
        const currentValue = fieldElement.textContent;
        const fieldName = fieldElement.dataset.field;
        const placeId = fieldElement.dataset.id;
        const isCategory = fieldName === "category";
        const isDetails = fieldName === "details";
        const isCoordinates = fieldName === "lat" || fieldName === "lng";

        fieldElement.dataset.originalValue = currentValue;
        let inputElement;

        if (isCategory) {
          inputElement = document.createElement("select");
          inputElement.className = "edit-select";
          const categories = [
            { value: "lodging", text: "×©××•×¨×™×" },
            { value: "attraction", text: "××ª×¨ ×ª×™×¨×•×ª×™" },
            { value: "restaurant", text: "××¡×¢×“×”" },
            { value: "cafe", text: "×‘×™×ª ×§×¤×”" },
            { value: "pub", text: "×¤××‘" },
            { value: "shopping", text: "×©×•×¤×™× ×’" },
            { value: "other", text: "××—×¨" },
          ];

          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.value;
            option.textContent = cat.text;
            if (currentValue === cat.text) option.selected = true;
            inputElement.appendChild(option);
          });
        } else if (isDetails) {
          inputElement = document.createElement("textarea");
          inputElement.className = "edit-textarea";
          inputElement.value = currentValue;
        } else {
          inputElement = document.createElement("input");
          inputElement.type = isCoordinates ? "number" : "text";
          inputElement.className = "edit-input";
          inputElement.value = currentValue;
        }

        const saveButton = document.createElement("button");
        saveButton.textContent = "×©××•×¨";
        saveButton.className = "save-btn";

        const cancelButton = document.createElement("button");
        cancelButton.textContent = "×‘×™×˜×•×œ";
        cancelButton.className = "cancel-btn";

        const buttonsContainer = document.createElement("div");
        buttonsContainer.className = "save-cancel-buttons";
        buttonsContainer.appendChild(saveButton);
        buttonsContainer.appendChild(cancelButton);

        const editContainer = document.createElement("div");
        editContainer.className = "edit-container";
        editContainer.appendChild(inputElement);
        editContainer.appendChild(buttonsContainer);

        fieldElement.innerHTML = "";
        fieldElement.appendChild(editContainer);
        inputElement.focus();

        saveButton.addEventListener("click", function (e) {
          e.stopPropagation();
          saveExistingPlaceEdit(fieldElement, inputElement, fieldName, placeId);
        });

        cancelButton.addEventListener("click", function (e) {
          e.stopPropagation();
          cancelEdit(fieldElement);
        });

        inputElement.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !isDetails) {
            e.preventDefault();
            saveExistingPlaceEdit(
              fieldElement,
              inputElement,
              fieldName,
              placeId
            );
          } else if (e.key === "Escape") {
            e.preventDefault();
            cancelEdit(fieldElement);
          }
        });

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
        }

        outsideClickHandler = function (e) {
          if (!fieldElement.contains(e.target)) {
            const inputElement = fieldElement.querySelector(
              ".edit-input, .edit-textarea, .edit-select"
            );
            if (inputElement) {
              saveExistingPlaceEdit(
                fieldElement,
                inputElement,
                fieldElement.dataset.field,
                fieldElement.dataset.id
              );
            }
          }
        };

        setTimeout(() => {
          document.addEventListener("click", outsideClickHandler);
        }, 10);
      }

      function saveExistingPlaceEdit(
        fieldElement,
        inputElement,
        fieldName,
        placeId
      ) {
        let newValue;
        if (inputElement.tagName === "SELECT") {
          newValue = inputElement.options[inputElement.selectedIndex].text;
        } else {
          newValue = inputElement.value
            .replace(/\\r\\n/g, "\n")
            .replace(/\\n/g, "\n")
            .replace(/\r\n/g, "\n")
            .replace(/\n/g, "\n");
        }

        fieldElement.textContent = newValue;
        fieldElement.addEventListener("click", function (e) {
          e.stopPropagation();
          startEditExistingField(this);
        });

        const placeIndex = places.findIndex((p) => p.id == placeId);
        if (placeIndex === -1) return;

        if (fieldName === "name") {
          places[placeIndex].name = newValue;
        } else if (fieldName === "address") {
          places[placeIndex].address = newValue;
        } else if (fieldName === "lat") {
          places[placeIndex].lat = parseFloat(newValue) || 0;
        } else if (fieldName === "lng") {
          places[placeIndex].lng = parseFloat(newValue) || 0;
        } else if (fieldName === "category") {
          places[placeIndex].category = inputElement.value;
        } else if (fieldName === "details") {
          places[placeIndex].details = newValue;
        }

        saveToLocalStorage();
        updateJSONPreview();

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
          outsideClickHandler = null;
        }

        currentEditField = null;
      }

      function editExistingPlace(id) {
        const placeIndex = places.findIndex((p) => p.id === id);
        if (placeIndex === -1) return;

        const place = places[placeIndex];

        const newName = prompt("×©× ×”××§×•×:", place.name) || place.name;
        const newAddress = prompt("×›×ª×•×‘×ª:", place.address) || place.address;
        const newLat = parseFloat(prompt("×§×• ×¨×•×—×‘:", place.lat)) || place.lat;
        const newLng = parseFloat(prompt("×§×• ××•×¨×š:", place.lng)) || place.lng;
        const newDetails = prompt("×¤×¨×˜×™×:", place.details) || place.details;

        let newCategory = place.category;
        const categoryInput = prompt(
          `×§×˜×’×•×¨×™×” (×”×–×Ÿ ××—×ª ××”××¤×©×¨×•×™×•×ª ×”×‘××•×ª):\n×©××•×¨×™×, ××ª×¨ ×ª×™×¨×•×ª×™, ××¡×¢×“×”, ×‘×™×ª ×§×¤×”, ×¤××‘, ×©×•×¤×™× ×’, ××—×¨`,
          getCategoryName(place.category)
        );

        if (categoryInput) {
          const categoryMap = {
            ×©××•×¨×™×: "lodging",
            "××ª×¨ ×ª×™×¨×•×ª×™": "attraction",
            ××¡×¢×“×”: "restaurant",
            "×‘×™×ª ×§×¤×”": "cafe",
            ×¤××‘: "pub",
            ×©×•×¤×™× ×’: "shopping",
            ××—×¨: "other",
          };
          newCategory = categoryMap[categoryInput] || place.category;
        }

        if (
          confirm(`âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¢×“×›×Ÿ ××ª ×”××§×•× "${place.name}"?`)
        ) {
          places[placeIndex] = {
            ...place,
            name: newName,
            address: newAddress,
            lat: newLat,
            lng: newLng,
            details: newDetails,
            category: newCategory,
          };

          saveToLocalStorage();
          showStatus(`âœ… "${newName}" ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”`, false);
        }
      }

      function deleteExistingPlace(id) {
        const placeIndex = places.findIndex((p) => p.id === id);
        if (placeIndex === -1) return;

        const placeName = places[placeIndex].name;

        if (
          confirm(
            `âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××§×•× "${placeName}"?\n\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`
          )
        ) {
          places.splice(placeIndex, 1);
          saveToLocalStorage();
          showStatus(`ğŸ—‘ï¸ "${placeName}" × ××—×§ ×‘×”×¦×œ×—×”`, false);
        }
      }

      function updateJSONPreview() {
        const jsonOutput = document.getElementById("json-output");
        const jsonData = places.map((place) => {
          const categoryMap = {
            lodging: "lodging",
            attraction: "attraction",
            restaurant: "restaurant",
            cafe: "cafe",
            pub: "pub",
            shopping: "shopping",
            other: "other",
          };
          return {
            id: place.id,
            category: categoryMap[place.category] || place.category,
            name: place.name,
            address: place.address,
            lat: place.lat,
            lng: place.lng,
            details: place.details,
          };
        });
        jsonOutput.textContent = JSON.stringify(jsonData, null, 2);
      }

      function downloadJSON() {
        if (places.length === 0) {
          showStatus("âŒ ××™×Ÿ ××§×•××•×ª ×œ×”×•×¨×“×”", true);
          return;
        }

        let fileName = prompt("×”×–×Ÿ ×©× ×œ×§×•×‘×¥ ×”-JSON:", "places");
        if (fileName === null || fileName.trim() === "") {
          fileName = "places";
        }

        fileName = fileName.trim();
        if (!fileName.toLowerCase().endsWith(".json")) {
          fileName += ".json";
        }

        const data = document.getElementById("json-output").textContent;
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus(`âœ… ×§×•×‘×¥ ${fileName} ×”×•×¨×“ ×‘×”×¦×œ×—×”!`, false);
      }

      function loadFromLocalStorage() {
        const savedPlaces = localStorage.getItem("savedPlaces");
        if (savedPlaces) {
          places = JSON.parse(savedPlaces);
          if (places.length > 0) {
            nextId = Math.max(...places.map((p) => p.id)) + 1;
          }
          updateJSONPreview();
          displayExistingPlaces();
          showStatus(`âœ… × ×˜×¢× ×• ${places.length} ××§×•××•×ª ××”×–×™×›×¨×•×Ÿ ×”××§×•××™`, false);
        }
      }

      function saveToLocalStorage() {
        localStorage.setItem("savedPlaces", JSON.stringify(places));
        displayExistingPlaces();
      }

      function clearLocalStorage() {
        if (
          confirm(
            "âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”××§×•××•×ª ××”×–×™×›×¨×•×Ÿ ×”××§×•××™?\n\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!"
          )
        ) {
          localStorage.removeItem("savedPlaces");
          places = [];
          nextId = Date.now();
          updateJSONPreview();
          document.getElementById("existing-places-container").innerHTML = "";
          document.getElementById("places-count").textContent = "";
          showStatus("ğŸ§¹ ×›×œ ×”××§×•××•×ª × ××—×§×• ××”×–×™×›×¨×•×Ÿ ×”××§×•××™", false);
          location.reload();
        }
      }

      function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const uploadedPlaces = JSON.parse(e.target.result);
            if (!Array.isArray(uploadedPlaces)) {
              throw new Error("×”×§×•×‘×¥ ××™× ×• ××›×™×œ ××¢×¨×š ×©×œ ××§×•××•×ª");
            }
            if (
              confirm(
                `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×—×œ×™×£ ××ª ${places.length} ×”××§×•××•×ª ×”×§×™×™××™× ×‘-${uploadedPlaces.length} ××§×•××•×ª ××”×§×•×‘×¥?`
              )
            ) {
              places = uploadedPlaces;
              if (places.length > 0) {
                nextId = Math.max(...places.map((p) => p.id)) + 1;
              }
              saveToLocalStorage();
              updateJSONPreview();
              showStatus(
                `âœ… × ×˜×¢× ×• ${places.length} ××§×•××•×ª ××”×§×•×‘×¥ ×‘×”×¦×œ×—×”`,
                false
              );
            }
          } catch (error) {
            console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥:", error);
            showStatus(`âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: ${error.message}`, true);
          }
        };
        reader.readAsText(file);
      }
      document
        .getElementById("clear-fields-btn")
        .addEventListener("click", clearInputFields);
      function clearInputFields() {
        document.getElementById("name").value = "";
        document.getElementById("city").value = "";
        document.getElementById("country").value = "";
        document.getElementById("category").selectedIndex = 0;
        location.reload();
      }
    </script>
  </body>
</html>
