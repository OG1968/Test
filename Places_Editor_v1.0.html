<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="search.png" type="image/png" />
    <link rel="apple-touch-icon" href="search.png" />
    <title>מערכת ניהול מקומות</title>
    <style>
      :root {
        --primary-color: #4361ee;
        --primary-hover: #3a56d4;
        --secondary-color: #3f37c9;
        --success-color: #0074c7;
        --success-hover: #007fa5;
        --danger-color: #ff0000;
        --danger-hover: #ff5757;
        --warning-color: #ff8c00;
        --warning-hover: #ffab44;
        --info-color: #2e6500;
        --dark-color: #1a1a2e;
        --light-color: #f8f9fa;
        --gray-color: #6c757d;
        --border-color: #dee2e6;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 4px 6px rgba(0, 0, 0, 0.15);
        --radius: 6px;
        --transition: all 0.2s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        direction: rtl;
        padding: 20px;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.5;
        color: #333;
        background-color: #deebff;
      }

      h1,
      h2 {
        color: var(--dark-color);
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        text-align: center;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 8px;
      }

      h2 {
        font-size: 1.4rem;
        margin-bottom: 0.2rem;
      }

      .form-group {
        margin-bottom: 0rem;
      }

      label {
        display: block;
        margin-bottom: 0rem;
        font-weight: 600;
        color: var(--dark-color);
      }

      textarea,
      input,
      select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        transition: var(--transition);
        background-color: white;
      }

      textarea:focus,
      input:focus,
      select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
      }

      textarea {
        height: 100px;
        resize: vertical;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        padding: 0.6rem 0.2rem;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        margin: 0.2rem 0;
        transition: var(--transition);
        box-shadow: var(--shadow);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
      }

      button:hover {
        background-color: var(--primary-hover);
        box-shadow: var(--shadow-hover);
      }

      button:active {
        transform: translateY(1px);
      }

      button:disabled {
        background-color: var(--gray-color);
        cursor: not-allowed;
        box-shadow: none;
      }

      #search-btn {
        background-color: var(--success-color);
      }

      #search-btn:hover {
        background-color: var(--success-hover);
      }

      #download-btn {
        background-color: var(--info-color);
        width: 50%;
        margin-top: 0.2rem;
      }

      #download-btn:hover {
        background-color: #19a400;
      }

      #upload-btn {
        background-color: var(--warning-color);
        width: 50%;
        margin-top: 0.2rem;
      }

      @media (max-width: 600px) {
        #download-btn,
        #upload-btn {
          width: 50%;
        }
      }

      #upload-btn:hover {
        background-color: var(--warning-hover);
      }

      button.delete {
        background-color: var(--danger-color);
      }

      button.delete:hover {
        background-color: var(--danger-hover);
      }

      #loading {
        display: none;
        margin-right: 0.4rem;
      }

      .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .place-item {
        background-color: white;
        padding: 1rem;
        margin-bottom: 0.8rem;
        border-radius: var(--radius);
        border-left: 3px solid var(--primary-color);
        box-shadow: var(--shadow);
      }

      #json-output {
        background-color: white;
        padding: 0.8rem;
        border-radius: var(--radius);
        white-space: pre-wrap;
        font-family: "Courier New", Courier, monospace;
        font-size: 0.85rem;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
        max-height: 250px;
        overflow-y: auto;
      }

      .status-message {
        padding: 0.6rem 0.8rem;
        margin: 0.8rem 0;
        border-radius: var(--radius);
        display: none;
        font-weight: 1000;
        box-shadow: var(--shadow);
      }

      .error {
        background-color: #ffebee;
        color: var(--danger-color);
        border-left: 3px solid var(--danger-color);
      }

      .success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border-left: 3px solid #2e7d32;
      }

      .search-result {
        margin-bottom: 0.8rem;
        padding: 0.8rem;
        background-color: white;
        border-radius: var(--radius);
        position: relative;
        box-shadow: var(--shadow);
        border-left: 3px solid var(--info-color);
      }

      .search-result.error-result {
        border-left-color: var(--danger-color);
      }

      .search-result.not-found {
        border-left-color: var(--warning-color);
      }

      .button-group {
        display: flex;
        gap: 0.6rem;
        margin-bottom: 0.2rem;
        width: 100%;
      }

      .button-group button {
        flex: 1;
        min-width: 0; /* כדי למנוע בעיות עם טקסט ארוך */
      }

      .search-buttons {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.6rem;
      }

      .search-buttons button {
        flex: 1;
      }

      .editable-field {
        padding: 0.4rem;
        margin: 0.4rem 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        min-height: 20px;
        transition: var(--transition);
        font-size: 0.9rem;
        line-height: 3;
      }

      .editable-field:hover {
        background-color: #f0f4f8;
        border-color: var(--primary-color);
      }

      .edit-container {
        position: relative;
        margin: 0.4rem 0;
      }

      .edit-input {
        width: 100%;
        padding: 0.6rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        margin-bottom: 0.4rem;
      }

      .edit-textarea {
        width: 100%;
        padding: 0.6rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        min-height: 80px;
        resize: vertical;
        margin-bottom: 0.4rem;
      }

      .edit-select {
        width: 100%;
        padding: 0.6rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius);
        box-sizing: border-box;
        font-size: 0.95rem;
        background-color: white;
        margin-bottom: 0.4rem;
      }

      .save-cancel-buttons {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.4rem;
      }

      .save-cancel-buttons button {
        padding: 0.5rem 0.6rem;
        font-size: 0.85rem;
        flex: 1;
      }

      .save-btn {
        background-color: #2e7d32;
      }

      .save-btn:hover {
        background-color: #1b5e20;
      }

      .cancel-btn {
        background-color: var(--danger-color);
      }

      .cancel-btn:hover {
        background-color: var(--danger-hover);
      }

      .update-options {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.6rem;
      }

      .update-options button {
        flex: 1;
        padding: 0.6rem;
        font-size: 0.85rem;
      }

      .update-btn {
        background-color: var(--warning-color);
      }

      .update-btn:hover {
        background-color: var(--warning-hover);
      }

      @media (max-width: 600px) {
        body {
          padding: 15px;
        }
        h1 {
          font-size: 1.6rem;
        }
        h2 {
          font-size: 1.2rem;
        }

        .search-buttons,
        .update-options,
        .save-cancel-buttons {
          flex-direction: column;
        }

        .button-group {
          flex-direction: row;
          gap: 0.6rem;
        }

        button {
          width: 100%;
        }

        #json-output {
          font-size: 0.8rem;
          max-height: 200px;
        }
      }

      .download-upload-group {
        display: flex;
        gap: 0.6rem;
        margin-top: 0.8rem;
      }
    </style>
  </head>
  <body>
    <h1>מערכת ניהול מקומות</h1>

    <div class="place-form">
      <div class="form-group">
        <label for="name">הזן שמות מקומות (שורות נפרדות)</label>
        <textarea
        id="name"
        required
        placeholder="הזן שם מקום אחד או יותר באופן הבא:
מגדל אייפל
שער הניצחון"
      ></textarea>

      <div class="form-group">
        <label for="city">עיר</label>
        <input type="text" id="city" placeholder="לדוגמה: פריז (En/Heb)" />
      </div>

      <div class="form-group">
        <label for="country">מדינה</label>
        <input type="text" id="country" placeholder="לדוגמה: צרפת (En/Heb)" />
      </div>

      <div class="form-group">
        <label for="category">קטגוריה</label>
        <select id="category">
          <option value="">בחר קטגוריה</option>
          <option value="lodging">שמורים</option>
          <option value="attraction">אתר תירותי</option>
          <option value="restaurant">מסעדה</option>
          <option value="cafe">בית קפה</option>
          <option value="pub">פאב</option>
          <option value="shopping">שופינג</option>
          <option value="other">אחר</option>
        </select>
      </div>

      <div class="button-group">
        <button id="search-btn">
          <span id="loading"><span class="spinner"></span> מחפש...</span>
          חפש מקומות
        </button>
        <button id="clear-btn" class="delete">נקה זיכרון</button>
      </div>
      <div id="status-message" class="status-message"></div>
    </div>

    <div id="search-results" style="display: none">
      <h2>תוצאות חיפוש</h2>
      <div id="results-container"></div>
    </div>

    <div>
      <h2>תצוגה מקדימה</h2>
      <pre id="json-output" dir="ltr">[]</pre>
    </div>

    <div class="download-upload-group">
      <button id="download-btn">הורד קובץ JSON</button>
      <button id="upload-btn">העלה קובץ JSON</button>
    </div>
    <input type="file" id="file-input" accept=".json" style="display: none" />

    <script>
      // משתנים גלובליים
      let places = [];
      let nextId = Date.now();
      let lastSearchResults = [];
      let currentEditField = null;
      let outsideClickHandler = null;
      let searchStatus = {
        found: 0,
        notFound: 0,
        duplicates: 0,
        errors: 0,
        updated: 0,
      };

      // אירועים
      document
        .getElementById("search-btn")
        .addEventListener("click", searchPlace);
      document
        .getElementById("download-btn")
        .addEventListener("click", downloadJSON);
      document
        .getElementById("clear-btn")
        .addEventListener("click", clearLocalStorage);
      document
        .getElementById("upload-btn")
        .addEventListener("click", function () {
          document.getElementById("file-input").click();
        });

      // טעינת נתונים מהזיכרון המקומי בעת טעינת הדף
      window.addEventListener("DOMContentLoaded", loadFromLocalStorage);

      // טיפול בהעלאת קובץ
      document
        .getElementById("file-input")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const uploadedPlaces = JSON.parse(e.target.result);
              if (!Array.isArray(uploadedPlaces)) {
                throw new Error("הקובץ אינו מכיל מערך של מקומות");
              }

              if (
                confirm(
                  `האם אתה בטוח שברצונך להחליף את ${places.length} המקומות הקיימים ב-${uploadedPlaces.length} מקומות מהקובץ?`
                )
              ) {
                places = uploadedPlaces;
                if (places.length > 0) {
                  nextId = Math.max(...places.map((p) => p.id)) + 1;
                }
                saveToLocalStorage();
                updateJSONPreview();
                showStatus(`נטענו ${places.length} מקומות מהקובץ בהצלחה`);
              }
            } catch (error) {
              console.error("שגיאה בטעינת הקובץ:", error);
              showStatus(`שגיאה בטעינת הקובץ: ${error.message}`, true);
            }
          };
          reader.readAsText(file);
        });

      // פונקציות עזר
      function showStatus(message, isError = false) {
        const statusDiv = document.getElementById("status-message");
        statusDiv.textContent = message;
        statusDiv.className = isError
          ? "status-message error"
          : "status-message success";
        statusDiv.style.display = "block";

        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 5000);
      }

      function cleanAddress(place) {
        if (place.address) {
          const addr = place.address;
          const street = [addr.road, addr.house_number]
            .filter(Boolean)
            .join(" ");
          const city = addr.city || addr.town || addr.village || "";
          const postcode = addr.postcode || "";
          const country = addr.country || "";

          return [street, postcode, city, country].filter(Boolean).join(", ");
        }
        return place.display_name || "Address unknown";
      }

      // מציאת רשומה קיימת לפי שם וכתובת
      function findExistingPlace(placeToFind, checkCategory = false) {
        return places.find((existingPlace) => {
          const nameMatch =
            existingPlace.name.toLowerCase() === placeToFind.name.toLowerCase();
          const addressMatch =
            existingPlace.address.toLowerCase() ===
            placeToFind.address.toLowerCase();
          return nameMatch && addressMatch;
        });
      }

      // טעינת נתונים מהזיכרון המקומי
      function loadFromLocalStorage() {
        const savedPlaces = localStorage.getItem("savedPlaces");
        if (savedPlaces) {
          places = JSON.parse(savedPlaces);
          if (places.length > 0) {
            nextId = Math.max(...places.map((p) => p.id)) + 1;
          }
          updateJSONPreview();
          showStatus(`נטענו ${places.length} מקומות מהזיכרון המקומי`);
        }
      }

      // שמירת הנתונים בזיכרון המקומי
      function saveToLocalStorage() {
        localStorage.setItem("savedPlaces", JSON.stringify(places));
      }

      // ניקוי הזיכרון המקומי
      function clearLocalStorage() {
  if (confirm("האם אתה בטוח שברצונך למחוק את כל המקומות מהזיכרון המקומי? פעולה זו לא ניתנת לביטול!")) {
    localStorage.removeItem("savedPlaces");
    places = [];
    nextId = Date.now();
    updateJSONPreview();
    showStatus("כל המקומות נמחקו מהזיכרון המקומי");
    location.reload(); // הוספת רענון הדף
  }
}

      // פונקציות עיקריות
      async function searchPlace() {
  const nameInput = document.getElementById("name").value;
  const city = document.getElementById("city").value.trim();
  const country = document.getElementById("country").value.trim();
  const category = document.getElementById("category").value;

  // מילון תרגום מורחב (ניתן להוסיף עוד ערכים)
  const hebrewToEnglish = {
    "מגדל אייפל": "Eiffel Tower",
    "פריז": "Paris",
    "צרפת": "France",
    "ירושלים": "Jerusalem",
    "תל אביב": "Tel Aviv",
    "ישראל": "Israel",
    "שער הניצחון": "Arc de Triomphe",
    "קטדרלת נוטרדאם": "Notre Dame Cathedral",
    "מוזיאון הלובר": "Louvre Museum",
    "טירת וינדזור": "Windsor Castle",
    "כיכר טרפלגר": "Trafalgar Square"
  };

  const placeNames = nameInput
    .split("\n")
    .map((line) => line.trim())
    .filter((line) => line && !line.startsWith("//") && !line.startsWith("#"));

  if (placeNames.length === 0) {
    showStatus("אנא הזן לפחות שם מקום אחד", true);
    return;
  }

  searchStatus = {
    found: 0,
    notFound: 0,
    duplicates: 0,
    errors: 0,
    updated: 0,
  };

  document.getElementById("loading").style.display = "inline";
  document.getElementById("search-btn").disabled = true;
  document.getElementById("results-container").innerHTML = "";
  showStatus(`מתחיל לחפש ${placeNames.length} מקומות...`);

  try {
    lastSearchResults = [];

    for (const name of placeNames) {
      try {
        let query = name;
        let translatedName = hebrewToEnglish[name];
        
        // נסה חיפוש ראשוני עם השם המקורי
        let found = await trySearch(name, city, country, category);
        
        // אם לא נמצא ונמצא תרגום, נסה עם השם המתורגם
        if (!found && translatedName) {
          showStatus(`מנסה חיפוש עם תרגום: ${name} -> ${translatedName}`);
          found = await trySearch(translatedName, city, country, category);
          
          if (found) {
            // עדכן את השם המקורי בתוצאה לשם העברי
            found.originalName = name;
          }
        }

        if (!found) {
          lastSearchResults.push({
            originalName: name,
            category: category,
            notFound: true,
            details: "פרטים נוספים לא זמינים",
          });
          searchStatus.notFound++;
          showStatus(
            `לא נמצא: ${name} (נמצאו: ${searchStatus.found}, לא נמצאו: ${searchStatus.notFound}, שגיאות: ${searchStatus.errors})`
          );
        }

        // כיבוד הגבלת שיעורי הבקשות של Nominatim
        await new Promise((resolve) => setTimeout(resolve, 1100));
      } catch (error) {
        console.error(`שגיאה בחיפוש ${name}:`, error);
        lastSearchResults.push({
          originalName: name,
          category: category,
          error: true,
          details: `שגיאה: ${error.message || "פרטים נוספים לא זמינים"}`,
        });
        searchStatus.errors++;
        showStatus(
          `שגיאה בחיפוש ${name}: ${
            error.message || "שגיאה לא ידועה"
          } (נמצאו: ${searchStatus.found}, לא נמצאו: ${
            searchStatus.notFound
          }, שגיאות: ${searchStatus.errors})`,
          true
        );
      }
    }

    displaySearchResults();
    showStatus(
      `סיום חיפוש - נמצאו: ${searchStatus.found}, לא נמצאו: ${searchStatus.notFound}, שגיאות: ${searchStatus.errors}`,
      searchStatus.found === 0 && searchStatus.errors > 0
    );
  } catch (error) {
    console.error("שגיאה כללית בחיפוש:", error);
    showStatus(
      `שגיאה כללית בחיפוש: ${
        error.message || "פרטים לא זמינים"
      } (נמצאו: ${searchStatus.found}, לא נמצאו: ${
        searchStatus.notFound
      }, שגיאות: ${searchStatus.errors})`,
      true
    );
  } finally {
    document.getElementById("loading").style.display = "none";
    document.getElementById("search-btn").disabled = false;
  }
}

async function trySearch(name, city, country, category) {
  // בניית שאילתה מותאמת - שם המקום בלבד או עם עיר/מדינה אם מוזן
  const queryParts = [name];
  if (city) queryParts.push(city);
  if (country) queryParts.push(country);
  const query = queryParts.join(", ");

  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(
    query
  )}&format=json&addressdetails=1&limit=1&accept-language=en`;

  const response = await fetch(url, {
    headers: {
      "User-Agent": "PlaceManagementApp/1.0",
      "Accept-Language": "en",
    },
  });

  if (!response.ok) {
    throw new Error(`שגיאת HTTP: ${response.status}`);
  }

  const result = await response.json();

  if (result && result.length > 0) {
    const foundPlace = result[0];
    lastSearchResults.push({
      ...foundPlace,
      originalName: name,
      category: category,
      details: foundPlace.type
        ? `${foundPlace.type}`
        : "פרטים נוספים לא זמינים",
    });
    searchStatus.found++;
    showStatus(
      `מצאתי: ${name} (נמצאו: ${searchStatus.found}, לא נמצאו: ${searchStatus.notFound}, שגיאות: ${searchStatus.errors})`
    );
    return true;
  }

  return false;
}

      function displaySearchResults() {
        const container = document.getElementById("results-container");
        container.innerHTML = "";

        if (lastSearchResults.length === 0) {
          container.innerHTML = "<p>לא נמצאו תוצאות</p>";
          return;
        }

        lastSearchResults.forEach((place, index) => {
          const div = document.createElement("div");
          div.className = "search-result";
          if (place.error) div.className += " error-result";
          if (place.notFound) div.className += " not-found";
          div.dataset.index = index;

          if (place.error) {
            div.innerHTML = `
              <div class="editable-field" data-field="name">${
                place.originalName
              }</div>
              <p style="color: var(--danger-color);">שגיאה בחיפוש: ${
                place.details
              }</p>
              <div class="search-buttons">
                <button onclick="addManualPlace('${place.originalName.replace(
                  /'/g,
                  "\\'"
                )}')">הוסף ידנית</button>
                <button onclick="removeSearchResult(${index})" class="delete">מחק</button>
              </div>
            `;
          } else if (place.notFound) {
            div.innerHTML = `
              <div class="editable-field" data-field="name">${
                place.originalName
              }</div>
              <p>לא נמצא</p>
              <p><strong>פרטים נוספים:</strong> <span class="editable-field" data-field="details" style="white-space: pre-line;">${
                place.details
              }</span></p>
              <div class="search-buttons">
                <button onclick="addManualPlace('${place.originalName.replace(
                  /'/g,
                  "\\'"
                )}')">הוסף ידנית</button>
                <button onclick="removeSearchResult(${index})" class="delete">מחק</button>
              </div>
            `;
          } else {
            const displayName = place.display_name.split(",")[0];
            div.innerHTML = `
              <div class="editable-field" data-field="name">${displayName}</div>
              <p><strong>כתובת:</strong> <span class="editable-field" data-field="address">${cleanAddress(
                place
              )}</span></p>
              <p><strong>קואורדינטות:</strong> 
                <span class="editable-field" data-field="lat">${
                  place.lat
                }</span>, 
                <span class="editable-field" data-field="lng">${
                  place.lon
                }</span>
              </p>
              <p><strong>קטגוריה:</strong> 
                <span class="editable-field" data-field="category">${
                  document.getElementById("category").options[
                    document.getElementById("category").selectedIndex
                  ].text
                }</span>
              </p>
              <p><strong>פרטים נוספים:</strong> <span class="editable-field" data-field="details" style="white-space: pre-line;">${
                place.details
              }</span></p>
              <div class="update-options">
                <button onclick="addSelectedPlace(${index})">הוסף כחדש</button>
                <button onclick="updateExistingPlace(${index})" class="update-btn">עדכן קיים</button>
                <button onclick="removeSearchResult(${index})" class="delete">מחק</button>
              </div>
            `;
          }

          container.appendChild(div);
        });

        document.querySelectorAll(".editable-field").forEach((field) => {
          field.addEventListener("click", function (e) {
            e.stopPropagation();

            if (currentEditField && currentEditField !== this) {
              const inputElement = currentEditField.querySelector(
                ".edit-input, .edit-textarea, .edit-select"
              );
              if (inputElement) {
                const fieldName = currentEditField.dataset.field;
                saveEdit(currentEditField, inputElement, fieldName);
              }
            }

            startEditField(this);
          });
        });

        document.getElementById("search-results").style.display = "block";
      }

      function startEditField(fieldElement) {
        if (fieldElement === currentEditField) {
          return;
        }

        if (currentEditField) {
          const inputElement = currentEditField.querySelector(
            ".edit-input, .edit-textarea, .edit-select"
          );
          if (inputElement) {
            const fieldName = currentEditField.dataset.field;
            saveEdit(currentEditField, inputElement, fieldName);
          }
        }

        currentEditField = fieldElement;
        const currentValue = fieldElement.textContent;
        const fieldName = fieldElement.dataset.field;
        const isCategory = fieldName === "category";
        const isDetails = fieldName === "details";
        const isCoordinates = fieldName === "lat" || fieldName === "lng";

        fieldElement.dataset.originalValue = currentValue;

        let inputElement;
        if (isCategory) {
          inputElement = document.createElement("select");
          inputElement.className = "edit-select";

          const categories = [
            { value: "lodging", text: "שמורים" },
            { value: "attraction", text: "אתר תירותי" },
            { value: "restaurant", text: "מסעדה" },
            { value: "cafe", text: "בית קפה" },
            { value: "pub", text: "פאב" },
            { value: "shopping", text: "שופינג" },
            { value: "other", text: "אחר" },
          ];

          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.value;
            option.textContent = cat.text;
            if (currentValue === cat.text) option.selected = true;
            inputElement.appendChild(option);
          });
        } else if (isDetails) {
          inputElement = document.createElement("textarea");
          inputElement.className = "edit-textarea";
          inputElement.value = currentValue;
        } else {
          inputElement = document.createElement("input");
          inputElement.type = isCoordinates ? "number" : "text";
          inputElement.className = "edit-input";
          inputElement.value = currentValue;
        }

        const saveButton = document.createElement("button");
        saveButton.textContent = "שמור";
        saveButton.className = "save-btn";

        const cancelButton = document.createElement("button");
        cancelButton.textContent = "ביטול";
        cancelButton.className = "cancel-btn";

        const buttonsContainer = document.createElement("div");
        buttonsContainer.className = "save-cancel-buttons";
        buttonsContainer.appendChild(saveButton);
        buttonsContainer.appendChild(cancelButton);

        const editContainer = document.createElement("div");
        editContainer.className = "edit-container";
        editContainer.appendChild(inputElement);
        editContainer.appendChild(buttonsContainer);

        fieldElement.innerHTML = "";
        fieldElement.appendChild(editContainer);
        inputElement.focus();

        saveButton.addEventListener("click", function (e) {
          e.stopPropagation();
          saveEdit(fieldElement, inputElement, fieldName);
        });

        cancelButton.addEventListener("click", function (e) {
          e.stopPropagation();
          cancelEdit(fieldElement);
        });

        inputElement.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !isDetails) {
            e.preventDefault();
            saveEdit(fieldElement, inputElement, fieldName);
          } else if (e.key === "Escape") {
            e.preventDefault();
            cancelEdit(fieldElement);
          }
        });

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
        }

        outsideClickHandler = function (e) {
          if (!fieldElement.contains(e.target)) {
            const inputElement = fieldElement.querySelector(
              ".edit-input, .edit-textarea, .edit-select"
            );
            if (inputElement) {
              saveEdit(fieldElement, inputElement, fieldElement.dataset.field);
            }
          }
        };

        setTimeout(() => {
          document.addEventListener("click", outsideClickHandler);
        }, 10);
      }

      function saveEdit(fieldElement, inputElement, fieldName) {
        let newValue;
        if (inputElement.tagName === "SELECT") {
          newValue = inputElement.options[inputElement.selectedIndex].text;
        } else {
          newValue = inputElement.value
            .replace(/\\r\\n/g, "\n")
            .replace(/\\n/g, "\n")
            .replace(/\r\n/g, "\n")
            .replace(/\n/g, "\n");
        }

        fieldElement.textContent = newValue;
        fieldElement.addEventListener("click", function (e) {
          e.stopPropagation();
          startEditField(this);
        });

        const resultIndex = parseInt(
          fieldElement.closest(".search-result").dataset.index
        );
        const place = lastSearchResults[resultIndex];

        if (fieldName === "name") {
          if (place.originalName) {
            place.originalName = newValue;
          }
          if (place.display_name) {
            const parts = place.display_name.split(",");
            parts[0] = newValue;
            place.display_name = parts.join(",");
          } else {
            place.display_name = newValue + ", " + (place.address || "");
          }
        } else if (fieldName === "address") {
          place.display_name = newValue;
        } else if (fieldName === "lat") {
          place.lat = parseFloat(newValue) || 0;
        } else if (fieldName === "lng") {
          place.lon = parseFloat(newValue) || 0;
        } else if (fieldName === "category") {
          place.category = inputElement.value;
        } else if (fieldName === "details") {
          place.details = newValue;
        }

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
          outsideClickHandler = null;
        }

        currentEditField = null;
      }

      function cancelEdit(fieldElement) {
        fieldElement.textContent = fieldElement.dataset.originalValue;
        fieldElement.addEventListener("click", function (e) {
          e.stopPropagation();
          startEditField(this);
        });

        if (outsideClickHandler) {
          document.removeEventListener("click", outsideClickHandler);
          outsideClickHandler = null;
        }

        currentEditField = null;
      }

      function removeSearchResult(index) {
        lastSearchResults.splice(index, 1);
        displaySearchResults();
        showStatus("הרשומה נמחקה בהצלחה");
      }

      function addSelectedPlace(index) {
        const place = lastSearchResults[index];
        const newPlace = {
          id: nextId++,
          category: place.category,
          name: place.display_name.split(",")[0] || place.originalName,
          address: cleanAddress(place),
          lat: parseFloat(place.lat),
          lng: parseFloat(place.lon),
          details: place.details || "פרטים נוספים לא זמינים",
        };

        const existingPlace = findExistingPlace(newPlace);
        if (existingPlace) {
          searchStatus.duplicates++;
          showStatus(
            `"${newPlace.name}" כבר קיים ברשימה (נמצאו: ${searchStatus.found}, לא נמצאו: ${searchStatus.notFound}, שגיאות: ${searchStatus.errors}, כפילויות: ${searchStatus.duplicates})`,
            true
          );
          return;
        }

        places.push(newPlace);
        saveToLocalStorage();
        updateJSONPreview();
        showStatus(
          `"${newPlace.name}" נוסף לרשימה בהצלחה (נמצאו: ${searchStatus.found}, לא נמצאו: ${searchStatus.notFound}, שגיאות: ${searchStatus.errors}, כפילויות: ${searchStatus.duplicates})`
        );
      }

      function updateExistingPlace(index) {
        const place = lastSearchResults[index];
        const updatedPlace = {
          id: nextId++,
          category: place.category,
          name: place.display_name?.split(",")[0] || place.originalName,
          address: cleanAddress(place),
          lat: parseFloat(place.lat),
          lng: parseFloat(place.lon),
          details: place.details || "פרטים נוספים לא זמינים",
        };

        const existingPlaceIndex = places.findIndex(
          (p) =>
            p.name.toLowerCase() === updatedPlace.name.toLowerCase() &&
            p.address.toLowerCase() === updatedPlace.address.toLowerCase()
        );

        if (existingPlaceIndex !== -1) {
          updatedPlace.id = places[existingPlaceIndex].id;
          Object.assign(places[existingPlaceIndex], updatedPlace);
          searchStatus.updated++;
          showStatus(
            `"${updatedPlace.name}" עודכן בהצלחה (קטגוריה: ${updatedPlace.category})`
          );
        } else {
          places.push(updatedPlace);
          showStatus(`"${updatedPlace.name}" נוסף לרשימה בהצלחה`);
        }

        saveToLocalStorage();
        updateJSONPreview();
      }

      function addManualPlace(name) {
        const category = document.getElementById("category").value;
        const details =
          prompt("הזן פרטים על המקום:", "פרטים על המקום") || "אין פרטים נוספים";

        const newPlace = {
          id: nextId++,
          category: category,
          name: name,
          address: prompt("הזן כתובת:", "כתובת לא ידועה") || "כתובת לא ידועה",
          lat: parseFloat(prompt("הזן קו רוחב:", "0")) || 0,
          lng: parseFloat(prompt("הזן קו אורך:", "0")) || 0,
          details: details.replace(/\r\n/g, "\n").replace(/\n/g, "\n"),
        };

        const existingPlace = findExistingPlace(newPlace);
        if (existingPlace) {
          if (
            confirm(
              `"${name}" כבר קיים ברשימה. האם ברצונך לעדכן את הרשומה הקיימת? (הקטגוריה תתעדכן מ-${existingPlace.category} ל-${newPlace.category})`
            )
          ) {
            Object.assign(existingPlace, newPlace);
            searchStatus.updated++;
            showStatus(
              `"${name}" עודכן בהצלחה (קטגוריה: ${newPlace.category})`
            );
          } else {
            searchStatus.duplicates++;
            showStatus(`"${name}" כבר קיים ברשימה ולא עודכן`, true);
            return;
          }
        } else {
          places.push(newPlace);
          showStatus(`"${name}" נוסף ידנית לרשימה`);
        }

        saveToLocalStorage();
        updateJSONPreview();
      }

      function updateJSONPreview() {
        const jsonOutput = document.getElementById("json-output");

        const jsonData = places.map((place) => {
          const categoryMap = {
            lodging: "lodging",
            attraction: "attraction",
            restaurant: "restaurant",
            cafe: "cafe",
            pub: "pub",
            shopping: "shopping",
            other: "other",
          };

          return {
            id: place.id,
            category: categoryMap[place.category] || place.category,
            name: place.name,
            address: place.address,
            lat: place.lat,
            lng: place.lng,
            details: place.details,
          };
        });

        jsonOutput.textContent = JSON.stringify(jsonData, null, 2);
      }

      function downloadJSON() {
        if (places.length === 0) {
          showStatus("אין מקומות להורדה", true);
          return;
        }

        let fileName = prompt("הזן שם לקובץ ה-JSON:", "places");

        if (fileName === null || fileName.trim() === "") {
          fileName = "places";
        }

        fileName = fileName.trim();

        if (!fileName.toLowerCase().endsWith(".json")) {
          fileName += ".json";
        }

        const data = document.getElementById("json-output").textContent;
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus(`קובץ ${fileName} הורד בהצלחה!`);
      }
    </script>
  </body>
</html>
